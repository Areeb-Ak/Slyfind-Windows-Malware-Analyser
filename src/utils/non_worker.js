import { Worker } from 'worker_threads'
import { readdirSync } from 'fs'
import { join } from 'node:path'
import { exec } from 'child_process'
import { promises as fs1 } from 'fs'

const { app } = require('electron')

function runModule(memdump) {
  return new Promise((resolve, reject) => {
    const appPath = app.getAppPath('userData')
    const vol_path = join(appPath, 'extraResources', 'v3', 'vol.py').replace(/\\app\.asar\\/g, '\\')

    let modules = ['pslist', 'dlllist', 'handles', 'malfind', 'modules', 'svcscan', 'callbacks']
    let completedWorkers = 0

    const handleWorkerCompletion = () => {
      completedWorkers++
      if (completedWorkers === modules.length) {
        console.log('All workers completed')
        resolve()
      }
    }
    for (let i = 0; i < modules.length; i++) {
      const worker = new Worker(join(appPath, 'src', 'utils', 'worker.js'))

      const outputFile = join(appPath, 'extraResources', 'v3', 'output', `${modules[i]}.json`).replace(/\\app\.asar\\/g, '\\')

      // Listening for messages from the worker thread
      worker.on('message', () => {
        worker.terminate()
        handleWorkerCompletion()
      })
      worker.on('error', (error) => {
        console.error(`Error in worker: ${error}`)
        reject(error)
      })

      // Sending data to the worker thread
      let command = `${memdump}^${modules[i]}^${vol_path}^${outputFile}`
      worker.postMessage(command)
    }
  })
}

async function ldr_async(memdump, plugin) {
  try {
    const appPath = app.getAppPath('userData')
    const vol_path = join(appPath, 'extraResources', 'v3', 'vol.py').replace(/\\app\.asar\\/g, '\\')
    const command = `python3 ${vol_path} -f ${memdump} windows.${plugin}`
    console.log('Command (Non-Worker):', plugin)
    const { stdout } = exec(command)

    const outputFile = join(appPath, 'extraResources', 'v3', 'output', `${plugin}.txt`).replace(/\\app\.asar\\/g, '\\')

    await fs1.writeFile(outputFile, stdout)
    console.log('\nCacheing complete\n')
    return stdout
  } catch (error) {
    console.log(error)
  }
}

function listRawFilesWithSpaces() {
  const appPath = app.getAppPath('userData')
  let result = ''
  let memfile = join(appPath, 'extraResources', 'exec').replace(/\\app\.asar\\/g, '\\')
  readdirSync(memfile).forEach((file) => {
    if (file.endsWith('.raw') || file.endsWith('.mem') || file.endsWith('.dmp')) {
      const filePath = join(appPath, 'extraResources', 'exec', file).replace(/\\app\.asar\\/g, '\\')
      result += filePath
    } else {
      return false
    }
  })
  return result
}

export { listRawFilesWithSpaces, ldr_async, runModule }
