import { exec } from 'child_process'
import { join } from 'node:path'

const { app } = require('electron')

function runmodel(csvfile) {
  const appPath = app.getAppPath('userData')

  const model_py_path = join(appPath, 'extraResources', 'v3', 'model', 'model.py').replace(
    /\\app\.asar\\/g,
    '\\'
  )

  const rf_model_path = join(
    appPath,
    'extraResources',
    'v3',
    'model',
    'compressed_ps_rf_model.pkl.xz'
  ).replace(/\\app\.asar\\/g, '\\')

  const scale_model_path = join(
    appPath,
    'extraResources',
    'v3',
    'model',
    'compressed_std_scaler_model.pkl.xz'
  ).replace(/\\app\.asar\\/g, '\\')

  const command = `python3 ${model_py_path} ${JSON.stringify(csvfile)} ${rf_model_path} ${scale_model_path}`
  return new Promise((resolve, reject) => {
    exec(command, (error, stdout, stderr) => {
      if (error) {
        console.error(`Error: ${error.message}`)
        reject(error.message)
        return
      }
      console.log(stdout)
      if (stderr) {
        console.error(`stderr: ${stderr}`)
        reject(stderr)
        return
      }
      const valid = stdout.replace(/'/g, '"')
      resolve(JSON.parse(valid))
    })
  })
}

export default runmodel
