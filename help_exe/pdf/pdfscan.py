from pdfid import pdfid
import fitz
from os.path import exists
from sys import argv

"""
Feature extraction of required columns for PDF malware analysis
"""
# getting data from pdfid

def bytes_to_kb(bytes):
    return bytes / (1024)

filename = [argv[1]]  # path of the PDF file

# checking file
if not exists(filename[0]):
    print("File not found")
    exit()
features = {'FileName': filename[0]}

pdf = fitz.open(filename[0])

try:
    features['Pages'] = pdf.page_count
except:
    features['Pages'] = -1

try:
    features['XrefLength'] = pdf.xref_length()
except:
    features['XrefLength'] = -1

try:
    features['TitleCharacters'] = len(pdf.metadata['title'])
except:
    features['TitleCharacters'] = -1

try:
    features['isEncrypted'] = pdf.is_encrypted
except:
    features['isEncrypted'] = -1

images_count = 0

for i in range(pdf.page_count):
    images_count += len(pdf.get_page_images(0))

emb_count = pdf.embfile_count()
emb_Size_sum = 0
if emb_count != 0:
    try:
        for i in range(pdf.embfile_count()):
            emb_Size_sum = pdf.embfile_info(i)
    except:
        features['EmbeddedFiles'] = -1
    else:
        features['EmbeddedFiles'] = emb_Size_sum/emb_count
else:
    features['EmbeddedFiles'] = 0

try:
    image = 0
    for i in range(pdf.page_count):
        image += pdf.get_page_images(i)
except:
    image = -1
features['Images'] = images_count

try:
    text = 0
    for page in pdf:
        if len(page.get_text().split()):
            text = 1
            break
    features['Text'] = text
except:
    features['Text'] = -1
try:
    options = pdfid.get_fake_options()
    options.scan = True
    options.json = True

    list_of_dict = pdfid.PDFiDMain(filename, options)

    pdf_features = list_of_dict['reports'][0]

    del pdf_features['version']

    # changes column names to corresponding to dataset names
    diff_in_feature_name = {
        'header': 'Header',
        'obj': 'Obj',
        'endobj': 'Endobj',
        'stream': 'Stream',
        'endstream': 'Endstream',
        'xref': 'Xref',
        'trailer': 'Trailer',
        'startxref': 'StartXref',
        '/Page': 'PageNo',
        '/Encrypt': 'Encrypt',
        '/ObjStm': 'ObjStm',
        '/JS': 'JS',
        '/JavaScript': 'Javascript',
        '/AA': 'AA',
        '/OpenAction': 'OpenAction',
        '/AcroForm': 'Acroform',
        '/JBIG2Decode': 'JBIG2Decode',
        '/RichMedia': 'RichMedia',
        '/Launch': 'Launch',
        '/EmbeddedFile': 'EmbeddedFile',
        '/XFA': 'XFA',
        '/Colors > 2^24': 'Colors'
    }
    for curr_name, new_name in diff_in_feature_name.items():
        pdf_features[new_name] = features.pop(curr_name)

    features.update(pdf_features)
except:
    features.update({
        'Header': '-1',
        'Obj': -1,
        'Endobj': -1,
        'Stream': -1,
        'Endstream': -1,
        'Xref': -1,
        'Trailer': -1,
        'StartXref': -1,
        'PageNo': -1,
        'Encrypt': -1,
        'ObjStm': -1,
        'JS': -1,
        'JavaScript': -1,
        'AA': -1,
        'OpenAction': -1,
        'AcroForm': -1,
        'JBIG2Decode': -1,
        'RichMedia': -1,
        'Launch': -1,
        'EmbeddedFile': -1,
        'XFA': -1,
        'Colors': -1})

if features['isEncrypted'] == False:
    features['isEncrypted'] = 0
else:
    features['isEncrypted'] = 1

print(features)